import "../common";

using Common;

namespace Tools;

//
// TOOL MODELS
//

enum ToolType {
    /** A tool that emulates a function call */
    function,

    /** A tool that uses one of the Julep integrations */
    integration,

    /** A tool that uses a system resource */
    system,

    /** A tool that makes an API call */
    api_call,
}

/** The parameters the functions accepts, described as a JSON Schema object. */
alias FunctionParameters = Record<unknown>;

alias ToolOutput = Record<unknown>;

alias ToolChoiceOption = "auto" | "none" | NamedToolChoice;

/** Function definition */
model FunctionDef {
    /** DO NOT USE: This will be overriden by the tool name. Here only for compatibility reasons. */
    name?: validPythonIdentifier = "overriden";

    /** The parameters the function accepts */
    parameters: FunctionParameters;

    /** Description of the function */
    description?: identifierSafeUnicode;
}

@discriminator("type")
model Tool {
    /** Whether this tool is a `function`, `api_call`, `system` etc. (Only `function` tool supported right now) */
    type: ToolType;

    /** The tool should be run in the background (not supported at the moment) */
    background: boolean = false;

    function?: FunctionDef;
    integration?: unknown;
    system?: unknown;
    api_call?: unknown;

    ...HasTimestamps;
    ...HasId;
}

model FunctionTool extends Tool {
    type: ToolType.function;
    background: false = false;

    /** The function to call */
    function: FunctionDef;
}

model FunctionCallOption {
    /** The name of the function */
    name: string;
}

@discriminator("type")
model NamedToolChoice {
    /** Whether this tool is a `function`, `api_call`, `system` etc. (Only `function` tool supported right now) */
    type: ToolType;

    /** The name of the tool/function */
    name: validPythonIdentifier;
    
    function?: FunctionCallOption;
    integration?: unknown;
    system?: unknown;
    api_call?: unknown;
}

model NamedFunctionChoice extends NamedToolChoice {
    type: ToolType.function;

    /** The function to call */
    function: FunctionCallOption;
}

model ToolResponse {
    @key id: uuid;

    /** The output of the tool */
    output: ToolOutput;
}

/** Payload for creating a tool */
@withVisibility("create")
model CreateToolRequest {
    ...Tool;
}

/** Payload for updating a tool */
@withVisibility("update")
model UpdateToolRequest {
    ...Tool;
}

/** Payload for patching a tool */
model PatchToolRequest is UpdateToolRequest {}

/** The response tool value generated by the model */
@discriminator("type")
model ChosenToolCall {
    /** Whether this tool is a `function`, `api_call`, `system` etc. (Only `function` tool supported right now) */
    type: ToolType;

    function?: FunctionCallOption;
    integration?: unknown;
    system?: unknown;
    api_call?: unknown;

    ...HasId;
}

model ChosenFunctionCall extends ChosenToolCall {
    type: ToolType.function;

    /** The function to call */
    function: FunctionCallOption;
}